generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id            String   @id @default(uuid())
  barcode       String   @unique
  name          String
  categoryId    String?
  supplierId    String?
  purchasePrice Decimal
  sellingPrice  Decimal
  taxRate       Decimal  @default(0)
  quantity      Decimal  @default(0)
  unit          String   @default("pcs")
  expiryDate    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  category      Category? @relation(fields: [categoryId], references: [id])
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  saleItems     SaleItem[]
  batches       StockBatch[]
  needToBuyItems NeedToBuy[]
}

model StockBatch {
  id                String   @id @default(uuid())
  productId         String
  supplierId        String?
  initialQuantity   Decimal @default(0)
  remainingQuantity Decimal @default(0)
  purchasePrice     Decimal
  expiryDate        DateTime?
  createdAt         DateTime @default(now())
  
  product           Product @relation(fields: [productId], references: [id])
  supplier          Supplier? @relation(fields: [supplierId], references: [id])
  adjustments       StockAdjustment[]
  saleItems         SaleItem[]
  
  billId            String?
  bill              Bill? @relation(fields: [billId], references: [id])
}

model Bill {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  store       String
  amount      Decimal
  notes       String?
  imagePath   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  batches     StockBatch[]
}

model StockAdjustment {
  id          String   @id @default(uuid())
  batchId     String
  oldQuantity Decimal
  newQuantity Decimal
  reason      String?
  createdAt   DateTime @default(now())
  
  batch       StockBatch @relation(fields: [batchId], references: [id])
}

model Supplier {
  id        String    @id @default(uuid())
  name      String    @unique
  contact   String?
  products  Product[]
  batches   StockBatch[]
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
}

model Sale {
  id              String     @id @default(uuid())
  createdAt       DateTime   @default(now())
  totalAmount     Decimal
  vatAmount       Decimal    @default(0)
  discountAmount  Decimal    @default(0)
  paymentMethod   String     // CASH, CARD, etc.
  items           SaleItem[]
}

model SaleItem {
  id            String  @id @default(uuid())
  saleId        String
  productId     String
  batchId       String? // Optional: Only populated for offer sales
  quantity      Decimal
  price         Decimal // Selling price at time of sale
  purchasePrice Decimal @default(0) // Purchase price (COGS) at time of sale
  originalPrice Decimal @default(0) // Regular price at time of sale (to track discounts)
  
  sale      Sale    @relation(fields: [saleId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
  batch     StockBatch? @relation(fields: [batchId], references: [id])
}

model NeedToBuy {
  id            String   @id @default(uuid())
  productId     String?  // Optional for new items
  name          String
  barcode       String?
  quantity      Decimal
  unit          String   @default("pcs")
  notes         String?
  isBought      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  product       Product? @relation(fields: [productId], references: [id])
}
